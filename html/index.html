<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>JimAuth</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body style="background-color: #eff0f0">
<div id="dashboard" class="container" style="margin-top: 25px;">
    <div class="row">
        <div id="header" class="col-md-12"></div>
    </div>
    <div class="row" style="margin-top: 100px;">
        <table id="table_users" class="table table-hover">
            <thead>
            <tr class="active" style="font-size: medium">
                <td width="60px">#</td><td width="140px">登录名</td><td width="140px">手机号码</td><td width="140px">经校验手机号码</td>
                <td width="140px">E-Mail</td><td width="140px">经校验的E-Mail</td><td width="60px">激活</td><td width="200px">创建时间</td>
                <td width="160px">操作</td>
            </tr>
            </thead>
            <tbody id="t_body" style="font-size: large;">
            </tbody>
        </table>
    </div>
    <div class="row" style="margin-top: 200px; margin-bottom: 50px;">
        <div id="footer" class="col-md-12" style="text-align: center;">
            ©2016 JimAuth
        </div>
    </div>
</div>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>
<script src="js/date_format.js"></script>
<script src="js/utils.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        var page = 1;
        var page_size = 20;

        $.ajax({
            url : '/auth/_list?page=' + page + '&page_size=' + page_size,
            type : 'GET',
            dataType: 'json',
            error : function(xhr, status, error) {
                insert_warning_window($('#footer'), '<strong>获取用户列表失败, 请联系管理员! </strong>');
            },
            success : function(result, status, xhr) {
                $(result.data).each(function(index, ele) {
                    var mobile_checkbox = Boolean(ele.mobile_phone_verified) ? '<input type="checkbox" checked disabled>' : '<input type="checkbox" disabled>';
                    var email_checkbox = Boolean(ele.email_verified) ? '<input type="checkbox" checked disabled>' : '<input type="checkbox" disabled>';
                    var enabled_checkbox = Boolean(ele.enabled) ? '<input type="checkbox" class="enabled_checkbox" style="width: 60px;" checked>' :
                            '<input type="checkbox" class="enabled_checkbox" style="width: 60px;">';
                    var trHTML = '<tr edit_mode=false>' +
                            '<td>' + String(ele.id) + '</td>' +
                            '<td>' + ele.login_name + '</td>' +
                            '<td>' + ele.mobile_phone + '</td>' +
                            '<td>' + mobile_checkbox + '</td>' +
                            '<td>' + ele.email + '</td>' +
                            '<td>' + email_checkbox + '</td>' +
                            '<td>' + enabled_checkbox + '</td>' +
                            '<td>' + new Date(parseInt(ele.create_time) * 1000).format("yyyy-mm-dd HH:MM:ss") + '</td>' +
                            '<td>' +
                                '<button type="button" class="btn btn-danger" onclick="user_delete(this)">删除</button>' +
                            '</td>' +
                            '</tr>';
                    $('#t_body').append(trHTML);
                });
            }
        });

        $("#t_body").on('click', "td:gt(0):lt(5)", function() {
            if ($(this).parent().attr('edit_mode') == 'false') {
                $(this).parent().attr('edit_mode', true);
                $(this).parent().attr('j_login_name', $(this).parent().find('td:eq(1)').html());
                $(this).parent().attr('j_mobile_phone', $(this).parent().find('td:eq(2)').html());
                $(this).parent().attr('j_email', $(this).parent().find('td:eq(4)').html());
                $(this).parent().attr('j_mobile_checkbox', $(this).parent().find('input[type="checkbox"]:eq(0)').is(':checked'));
                $(this).parent().attr('j_email_checkbox', $(this).parent().find('input[type="checkbox"]:eq(1)').is(':checked'));
                $(this).parent().attr('j_enabled_checkbox', $(this).parent().find('input[type="checkbox"]:eq(2)').is(':checked'));

                $(this).parent().find('td:eq(1)').html('<input type="text" value="' + $(this).parent().find('td:eq(1)').html() + '" />');
                $(this).parent().find('td:eq(2)').html('<input type="text" value="' + $(this).parent().find('td:eq(2)').html() + '" />');
                $(this).parent().find('td:eq(4)').html('<input type="text" value="' + $(this).parent().find('td:eq(4)').html() + '" />');
                $(this).parent().find('td:eq(8)').html('<button type="button" class="btn btn-info" onclick="user_update(this)">更新</button> | ' +
                        '<button type="button" class="btn btn-default" onclick="user_cancel(this)">取消</button>');
                $(this).parent().find('input[type="checkbox"]:eq(0)').removeAttr('disabled');
                $(this).parent().find('input[type="checkbox"]:eq(1)').removeAttr('disabled');
            }
        });

        $("#t_body").on('click', ".enabled_checkbox", function() {
            var id = $(this).parent().parent().find('td:eq(0) input').val();
            var action_url = '/mgmt/_enable/';

            if ($(this)[0].checked) {
                action_url = '/mgmt/_disable/';
            }
            $.ajax({
                url : action_url + id,
                type : 'PATCH',
                error : function() {
                    insert_warning_window($('#header'), '<strong>更改账户状态失败, 请联系管理员! </strong>');
                },
                success : function() {
                    window.location.href="/";
                }
            });
        });
    });

    function user_update(me) {
        $(me).parent().parent().attr('edit_mode', false);
        var id = $(me).parent().parent().find('td:eq(0)').text();
        var login_name = $(me).parent().parent().find('td:eq(1) input').val();
        var mobile_phone = $(me).parent().parent().find('td:eq(2) input').val();
        var email = $(me).parent().parent().find('td:eq(4) input').val();
        var mobile_phone_verified = $(me).parent().parent().find('input[type="checkbox"]')[0].checked;
        var email_verified = $(me).parent().parent().find('input[type="checkbox"]')[1].checked;

        $(me).parent().parent().find('td:eq(1)').html($(me).parent().parent().find('td:eq(1) input').val());
        $(me).parent().parent().find('td:eq(2)').html($(me).parent().parent().find('td:eq(2) input').val());
        $(me).parent().parent().find('td:eq(4)').html($(me).parent().parent().find('td:eq(4) input').val());
        $(me).parent().parent().find('input[type="checkbox"]:eq(0)').attr('disabled', true);
        $(me).parent().parent().find('input[type="checkbox"]:eq(1)').attr('disabled', true);
        $(me).parent().html('<button type="button" class="btn btn-danger" onclick="user_delete(this)">删除</button>');

        $.ajax({
            url : '/auth/_update',
            type : 'PUT',
            contentType: "application/json; charset=utf-8",
            data : JSON.stringify({
                id: id,
                login_name: login_name,
                mobile_phone: mobile_phone,
                mobile_phone_verified: mobile_phone_verified,
                email: email,
                email_verified: email_verified
            }),
            error : function() {
                insert_warning_window($('#footer'), '<strong>更新用户信失败, 请联系管理员! </strong>');
            },
            success : function() {
                window.location.href="/";
            }
        });
    }

    function user_delete(me) {
        var id = $(me).parent().parent().find('td:eq(0) input').val();
        $.ajax({
            url : '/mgmt/' + id,
            type : 'DELETE',
            error : function() {
                insert_warning_window($('#footer'), '<strong>删除用户信失败, 请联系管理员! </strong>');
            },
            success : function() {
                window.location.href="/";
            }
        });
    }

    function user_cancel(me) {
        $(me).parent().parent().attr('edit_mode', false);
        $(me).parent().parent().find('td:eq(1)').html($(me).parent().parent().attr('j_login_name'));
        $(me).parent().parent().find('td:eq(2)').html($(me).parent().parent().attr('j_mobile_phone'));
        $(me).parent().parent().find('td:eq(4)').html($(me).parent().parent().attr('j_email'));

        if ($(me).parent().parent().attr('j_mobile_checkbox') == 'false') {
            $(me).parent().parent().find('input[type="checkbox"]:eq(0)').prop('checked', false);
        } else {
            $(me).parent().parent().find('input[type="checkbox"]:eq(0)').prop('checked', true);
        }

        if ($(me).parent().parent().attr('j_email_checkbox') == 'false') {
            $(me).parent().parent().find('input[type="checkbox"]:eq(1)').prop('checked', false);
        } else {
            $(me).parent().parent().find('input[type="checkbox"]:eq(1)').prop('checked', true);
        }

        $(me).parent().parent().find('input[type="checkbox"]:eq(0)').attr('disabled', true);
        $(me).parent().parent().find('input[type="checkbox"]:eq(1)').attr('disabled', true);
        $(me).parent().html('<button type="button" class="btn btn-danger" onclick="user_delete(this)">删除</button>');
    }
</script>
</body>
</html>